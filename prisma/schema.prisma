// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/lib/prisma"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  USER
  TRADER
  ADMIN
}

model User {
  id                String             @id @default(cuid())
  email             String             @unique
  username          String             @unique
  passwordHash      String
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  lastLogin         DateTime?
  firstName         String?
  lastName          String?
  fullName          String?
  initials          String?
  balance           Float?             @default(0)
  currency          String?            @default("USD")
  phone             String?
  country           String?
  address           String?
  profileImage      String?
  displayName       String?
  verified          Boolean?           @default(false)
  role              UserRole           @default(USER)
  status            String             @default("active") // active, deactivated
  // Trader specific fields
  followers         Int?
  winRate           Float?
  wins              Int?
  losses            Int?
  traderTrades      Int?
  minStartup        Float?
  wallets           Json?              @default("[]")
  assets            Json?              @default("[]")
  deposits          Deposit[]
  withdrawals       Withdrawal[]
  userSubscriptions UserSubscription[]
  walletConnections WalletConnection[]
  userAssets        UserAsset[]
  userAssetBalances UserAssetBalance[]
  userStakes        UserStake[]
  trades            Trade[]
  adminAuditLogs    AdminAuditLog[]
  postedTrades      PostedTrade[]
  executedTrades    TraderTrade[]
  copiedTrades      CopiedTrade[]    @relation("CopiedTradesUser")
  copiedTradesAsTrader CopiedTrade[] @relation("CopiedTradesTrader")
}

model Admin {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  role         UserRole @default(ADMIN)
  createdAt    DateTime @default(now())
  adminAuditLogs AdminAuditLog[]
}

model Deposit {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount    Float
  method    String
  status    String   @default("pending") // pending, approved, declined
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Withdrawal {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  amountUsd Float
  status    String   @default("pending") // pending, approved, declined
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DepositMethod {
  id          String   @id @default(cuid())
  name        String   @unique
  enabled     Boolean  @default(true)
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model SubscriptionPlan {
  id                String             @id @default(cuid())
  name              String
  price             Float
  duration          String // e.g., "monthly", "yearly"
  features          Json // JSON array or object of features
  enabled           Boolean            @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  userSubscriptions UserSubscription[]
}

model UserSubscription {
  id             String           @id @default(cuid())
  userId         String
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscriptionId String
  subscription   SubscriptionPlan @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  status         String           @default("active") // active, completed, cancelled
  startDate      DateTime         @default(now())
  endDate        DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
}

model StakingOption {
  id          String   @id @default(cuid())
  name        String
  description String?
  roi         Float
  duration    Int // in days
  minimum     Float
  maximum     Float?
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model WalletConnection {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String // e.g., "metamask", "walletconnect"
  address   String
  connected Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Asset {
  id        String      @id @default(cuid())
  symbol    String      @unique
  name      String
  priceUsd  Float
  logoUrl   String?
  stakingEnabled Boolean @default(false)
  stakeMin  Float?
  stakeMax  Float?
  stakeRoi  Float?
  stakeCycleDays Int?
  createdAt DateTime    @default(now())
  userAssets UserAsset[]
  userAssetBalances UserAssetBalance[]
  userStakes UserStake[]
  trades    Trade[]
  postedTrades PostedTrade[]
  traderTrades TraderTrade[]
}

model UserAsset {
  id      String @id @default(cuid())
  userId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  assetId String
  asset   Asset  @relation(fields: [assetId], references: [id], onDelete: Cascade)
  balance Float  @default(0)

  @@unique([userId, assetId])
}

model UserAssetBalance {
  id      String @id @default(cuid())
  userId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  assetId String
  asset   Asset  @relation(fields: [assetId], references: [id], onDelete: Cascade)
  balance Float  @default(0)

  @@unique([userId, assetId])
}

model UserStake {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  assetId   String
  asset     Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)
  amount    Float
  roi       Float
  cycleDays Int
  startDate DateTime @default(now())
  endDate   DateTime
  status    String   @default("active") // active, completed
}

model Trade {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  assetId   String
  asset     Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)
  tradeType String // "buy" or "sell"
  amount    Float
  priceUsd  Float
  createdAt DateTime @default(now())
}

model AdminAuditLog {
  id        String   @id @default(cuid())
  adminId   String
  admin     Admin    @relation(fields: [adminId], references: [id])
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  action    String
  details   Json
  createdAt DateTime @default(now())
}

model PostedTrade {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  assetId    String?
  asset      Asset?   @relation(fields: [assetId], references: [id], onDelete: Cascade)
  name       String
  username   String
  followers  Int
  winRate    Float
  wins       Int
  losses     Int
  trades     Int
  minStartup Float
  createdAt  DateTime @default(now())
}

model TraderTrade {
  id        String   @id @default(cuid())
  traderId  String
  trader    User     @relation(fields: [traderId], references: [id], onDelete: Cascade)
  assetId   String
  asset     Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)
  date      DateTime
  size      Float
  profit    Float
  createdAt DateTime @default(now())
  copiedTrades CopiedTrade[]
}

model CopiedTrade {
  id       String @id @default(cuid())
  userId   String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade, name: "CopiedTradesUser")
  traderId String
  trader   User   @relation(fields: [traderId], references: [id], onDelete: Cascade, name: "CopiedTradesTrader")
  tradeId  String?
  trade    TraderTrade?  @relation(fields: [tradeId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, traderId])
}
